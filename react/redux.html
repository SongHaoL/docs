<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rudex 与 React-Redux | 前端工程师成长路线</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/docs/images/favicon.png">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/bmob/hydrogen-js-sdk/dist/Bmob-2.2.4.min.js"></script>
    <meta name="description" content="博客 分享 读后感 成长规划">
    <meta name="theme-color" content="#00adb5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#00adb5">
    <meta itemprop="name" content="前端工程师成长路线">
    <meta itemprop="image" content="/my-blogs/images/favicon.png">
    <link rel="preload" href="/docs/assets/css/0.styles.a5c765a3.css" as="style"><link rel="preload" href="/docs/assets/js/app.8c7fcf95.js" as="script"><link rel="preload" href="/docs/assets/js/2.346c741e.js" as="script"><link rel="preload" href="/docs/assets/js/159.dd6ae020.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.448efd45.js"><link rel="prefetch" href="/docs/assets/js/100.fae1f295.js"><link rel="prefetch" href="/docs/assets/js/101.3cd81eca.js"><link rel="prefetch" href="/docs/assets/js/102.a3c75686.js"><link rel="prefetch" href="/docs/assets/js/103.ff124445.js"><link rel="prefetch" href="/docs/assets/js/104.7c0250f8.js"><link rel="prefetch" href="/docs/assets/js/105.c951f9f3.js"><link rel="prefetch" href="/docs/assets/js/106.fdf73f24.js"><link rel="prefetch" href="/docs/assets/js/107.407f43d1.js"><link rel="prefetch" href="/docs/assets/js/108.a7505ba2.js"><link rel="prefetch" href="/docs/assets/js/109.8116e3b4.js"><link rel="prefetch" href="/docs/assets/js/11.6b84f53c.js"><link rel="prefetch" href="/docs/assets/js/110.8c7e56d6.js"><link rel="prefetch" href="/docs/assets/js/111.9c8d3d82.js"><link rel="prefetch" href="/docs/assets/js/112.69669fa1.js"><link rel="prefetch" href="/docs/assets/js/113.315c1aab.js"><link rel="prefetch" href="/docs/assets/js/114.808f9724.js"><link rel="prefetch" href="/docs/assets/js/115.3d1fbad9.js"><link rel="prefetch" href="/docs/assets/js/116.77832c80.js"><link rel="prefetch" href="/docs/assets/js/117.900392ca.js"><link rel="prefetch" href="/docs/assets/js/118.6fe81f17.js"><link rel="prefetch" href="/docs/assets/js/119.a7c8bc4a.js"><link rel="prefetch" href="/docs/assets/js/12.8bcafd6e.js"><link rel="prefetch" href="/docs/assets/js/120.c9b8aa9b.js"><link rel="prefetch" href="/docs/assets/js/121.fbc3daa4.js"><link rel="prefetch" href="/docs/assets/js/122.ba51161d.js"><link rel="prefetch" href="/docs/assets/js/123.735b30b7.js"><link rel="prefetch" href="/docs/assets/js/124.ba35c0ae.js"><link rel="prefetch" href="/docs/assets/js/125.ec715272.js"><link rel="prefetch" href="/docs/assets/js/126.dc431365.js"><link rel="prefetch" href="/docs/assets/js/127.b6f28734.js"><link rel="prefetch" href="/docs/assets/js/128.46207642.js"><link rel="prefetch" href="/docs/assets/js/129.7c3bbe7c.js"><link rel="prefetch" href="/docs/assets/js/13.4455f4e8.js"><link rel="prefetch" href="/docs/assets/js/130.5d044c8a.js"><link rel="prefetch" href="/docs/assets/js/131.0200a303.js"><link rel="prefetch" href="/docs/assets/js/132.7cb59737.js"><link rel="prefetch" href="/docs/assets/js/133.c15bf84c.js"><link rel="prefetch" href="/docs/assets/js/134.3dea2520.js"><link rel="prefetch" href="/docs/assets/js/135.8fd41d0c.js"><link rel="prefetch" href="/docs/assets/js/136.f966ed00.js"><link rel="prefetch" href="/docs/assets/js/137.db334cf3.js"><link rel="prefetch" href="/docs/assets/js/138.9d057e9a.js"><link rel="prefetch" href="/docs/assets/js/139.1b75c557.js"><link rel="prefetch" href="/docs/assets/js/14.3b0be226.js"><link rel="prefetch" href="/docs/assets/js/140.35cf529e.js"><link rel="prefetch" href="/docs/assets/js/141.b3de3e13.js"><link rel="prefetch" href="/docs/assets/js/142.294520e4.js"><link rel="prefetch" href="/docs/assets/js/143.5ae18b07.js"><link rel="prefetch" href="/docs/assets/js/144.b173db47.js"><link rel="prefetch" href="/docs/assets/js/145.f2d44f37.js"><link rel="prefetch" href="/docs/assets/js/146.44948606.js"><link rel="prefetch" href="/docs/assets/js/147.fcc04391.js"><link rel="prefetch" href="/docs/assets/js/148.1f4ccdc6.js"><link rel="prefetch" href="/docs/assets/js/149.a8553248.js"><link rel="prefetch" href="/docs/assets/js/15.4b5d7343.js"><link rel="prefetch" href="/docs/assets/js/150.e762acbd.js"><link rel="prefetch" href="/docs/assets/js/151.84101683.js"><link rel="prefetch" href="/docs/assets/js/152.481ffa05.js"><link rel="prefetch" href="/docs/assets/js/153.3384c5e3.js"><link rel="prefetch" href="/docs/assets/js/154.a16635df.js"><link rel="prefetch" href="/docs/assets/js/155.d65170ad.js"><link rel="prefetch" href="/docs/assets/js/156.d3912eb6.js"><link rel="prefetch" href="/docs/assets/js/157.4cac489f.js"><link rel="prefetch" href="/docs/assets/js/158.e260917e.js"><link rel="prefetch" href="/docs/assets/js/16.9d0963b3.js"><link rel="prefetch" href="/docs/assets/js/160.824aac5f.js"><link rel="prefetch" href="/docs/assets/js/161.71c2cda7.js"><link rel="prefetch" href="/docs/assets/js/162.d3151b7e.js"><link rel="prefetch" href="/docs/assets/js/163.84297f8a.js"><link rel="prefetch" href="/docs/assets/js/164.41add528.js"><link rel="prefetch" href="/docs/assets/js/165.6af85c21.js"><link rel="prefetch" href="/docs/assets/js/166.fb6cb500.js"><link rel="prefetch" href="/docs/assets/js/167.7da713e1.js"><link rel="prefetch" href="/docs/assets/js/168.a6add8c4.js"><link rel="prefetch" href="/docs/assets/js/169.a01126be.js"><link rel="prefetch" href="/docs/assets/js/17.95b7e490.js"><link rel="prefetch" href="/docs/assets/js/170.a97cef1a.js"><link rel="prefetch" href="/docs/assets/js/171.438f8be5.js"><link rel="prefetch" href="/docs/assets/js/172.f6c40b86.js"><link rel="prefetch" href="/docs/assets/js/173.a1d8efe4.js"><link rel="prefetch" href="/docs/assets/js/174.f97fba7e.js"><link rel="prefetch" href="/docs/assets/js/175.3a3b0a5c.js"><link rel="prefetch" href="/docs/assets/js/176.abb36d15.js"><link rel="prefetch" href="/docs/assets/js/177.b525c7c6.js"><link rel="prefetch" href="/docs/assets/js/178.6cbda090.js"><link rel="prefetch" href="/docs/assets/js/179.fba2a07c.js"><link rel="prefetch" href="/docs/assets/js/18.ca0afb77.js"><link rel="prefetch" href="/docs/assets/js/180.c90f194d.js"><link rel="prefetch" href="/docs/assets/js/181.4e43287b.js"><link rel="prefetch" href="/docs/assets/js/19.981481df.js"><link rel="prefetch" href="/docs/assets/js/20.6e80cd2d.js"><link rel="prefetch" href="/docs/assets/js/21.c0ec8375.js"><link rel="prefetch" href="/docs/assets/js/22.648850d3.js"><link rel="prefetch" href="/docs/assets/js/23.73ed5316.js"><link rel="prefetch" href="/docs/assets/js/24.768a95fb.js"><link rel="prefetch" href="/docs/assets/js/25.b460e9a9.js"><link rel="prefetch" href="/docs/assets/js/26.61c56597.js"><link rel="prefetch" href="/docs/assets/js/27.2bbfe116.js"><link rel="prefetch" href="/docs/assets/js/28.efc0814f.js"><link rel="prefetch" href="/docs/assets/js/29.8bebb742.js"><link rel="prefetch" href="/docs/assets/js/3.f0b9dcd8.js"><link rel="prefetch" href="/docs/assets/js/30.e6180f81.js"><link rel="prefetch" href="/docs/assets/js/31.791f6adb.js"><link rel="prefetch" href="/docs/assets/js/32.59f79bfb.js"><link rel="prefetch" href="/docs/assets/js/33.24072082.js"><link rel="prefetch" href="/docs/assets/js/34.9cc3face.js"><link rel="prefetch" href="/docs/assets/js/35.f5942d3c.js"><link rel="prefetch" href="/docs/assets/js/36.dd226553.js"><link rel="prefetch" href="/docs/assets/js/37.12a8e708.js"><link rel="prefetch" href="/docs/assets/js/38.0c48b0a9.js"><link rel="prefetch" href="/docs/assets/js/39.9d41280d.js"><link rel="prefetch" href="/docs/assets/js/4.0f806da2.js"><link rel="prefetch" href="/docs/assets/js/40.494e0bb7.js"><link rel="prefetch" href="/docs/assets/js/41.e2242735.js"><link rel="prefetch" href="/docs/assets/js/42.f6d801aa.js"><link rel="prefetch" href="/docs/assets/js/43.51c3e56f.js"><link rel="prefetch" href="/docs/assets/js/44.a096b57c.js"><link rel="prefetch" href="/docs/assets/js/45.2d938602.js"><link rel="prefetch" href="/docs/assets/js/46.5462b19e.js"><link rel="prefetch" href="/docs/assets/js/47.3693a81a.js"><link rel="prefetch" href="/docs/assets/js/48.1d984385.js"><link rel="prefetch" href="/docs/assets/js/49.75eb0693.js"><link rel="prefetch" href="/docs/assets/js/5.7088cd54.js"><link rel="prefetch" href="/docs/assets/js/50.06ea30e6.js"><link rel="prefetch" href="/docs/assets/js/51.95767db4.js"><link rel="prefetch" href="/docs/assets/js/52.036a427b.js"><link rel="prefetch" href="/docs/assets/js/53.03e8160e.js"><link rel="prefetch" href="/docs/assets/js/54.3f89c021.js"><link rel="prefetch" href="/docs/assets/js/55.ee276a6b.js"><link rel="prefetch" href="/docs/assets/js/56.c18fddc1.js"><link rel="prefetch" href="/docs/assets/js/57.80455c3d.js"><link rel="prefetch" href="/docs/assets/js/58.8ffe2d5a.js"><link rel="prefetch" href="/docs/assets/js/59.5adb1a11.js"><link rel="prefetch" href="/docs/assets/js/6.aa27b4b3.js"><link rel="prefetch" href="/docs/assets/js/60.35ada18a.js"><link rel="prefetch" href="/docs/assets/js/61.127f120e.js"><link rel="prefetch" href="/docs/assets/js/62.0d882604.js"><link rel="prefetch" href="/docs/assets/js/63.57f410fd.js"><link rel="prefetch" href="/docs/assets/js/64.f121b763.js"><link rel="prefetch" href="/docs/assets/js/65.76ef0090.js"><link rel="prefetch" href="/docs/assets/js/66.a39ac5ac.js"><link rel="prefetch" href="/docs/assets/js/67.499d3620.js"><link rel="prefetch" href="/docs/assets/js/68.7c04c7a8.js"><link rel="prefetch" href="/docs/assets/js/69.e58396ea.js"><link rel="prefetch" href="/docs/assets/js/7.6653ed24.js"><link rel="prefetch" href="/docs/assets/js/70.2ce6d316.js"><link rel="prefetch" href="/docs/assets/js/71.80443b6f.js"><link rel="prefetch" href="/docs/assets/js/72.f224489d.js"><link rel="prefetch" href="/docs/assets/js/73.0f73eb62.js"><link rel="prefetch" href="/docs/assets/js/74.a6215b26.js"><link rel="prefetch" href="/docs/assets/js/75.1dd84ab6.js"><link rel="prefetch" href="/docs/assets/js/76.f706d67e.js"><link rel="prefetch" href="/docs/assets/js/77.583d7e47.js"><link rel="prefetch" href="/docs/assets/js/78.add671e4.js"><link rel="prefetch" href="/docs/assets/js/79.6fc1e8ae.js"><link rel="prefetch" href="/docs/assets/js/8.a8d55efb.js"><link rel="prefetch" href="/docs/assets/js/80.ac37b44e.js"><link rel="prefetch" href="/docs/assets/js/81.22269b9e.js"><link rel="prefetch" href="/docs/assets/js/82.5e87105a.js"><link rel="prefetch" href="/docs/assets/js/83.c163ad45.js"><link rel="prefetch" href="/docs/assets/js/84.ea4c4f56.js"><link rel="prefetch" href="/docs/assets/js/85.c85d59a7.js"><link rel="prefetch" href="/docs/assets/js/86.c72e064f.js"><link rel="prefetch" href="/docs/assets/js/87.b3b4b378.js"><link rel="prefetch" href="/docs/assets/js/88.427e7539.js"><link rel="prefetch" href="/docs/assets/js/89.3e80f38e.js"><link rel="prefetch" href="/docs/assets/js/9.7d808dd7.js"><link rel="prefetch" href="/docs/assets/js/90.98e5fa17.js"><link rel="prefetch" href="/docs/assets/js/91.eec311e8.js"><link rel="prefetch" href="/docs/assets/js/92.e69c17dd.js"><link rel="prefetch" href="/docs/assets/js/93.819ed333.js"><link rel="prefetch" href="/docs/assets/js/94.fdb7e62a.js"><link rel="prefetch" href="/docs/assets/js/95.e7fa30b5.js"><link rel="prefetch" href="/docs/assets/js/96.3de3ec3c.js"><link rel="prefetch" href="/docs/assets/js/97.2126926f.js"><link rel="prefetch" href="/docs/assets/js/98.60f1bc26.js"><link rel="prefetch" href="/docs/assets/js/99.b65571cc.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.a5c765a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">前端工程师成长路线</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/react/.html" class="nav-link">
  css tricks
</a></div><div class="nav-item"><a href="/docs/react/.html" class="nav-link">
  js tricks
</a></div> <a href="https://github.com/xjl271314/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/react/.html" class="nav-link">
  css tricks
</a></div><div class="nav-item"><a href="/docs/react/.html" class="nav-link">
  js tricks
</a></div> <a href="https://github.com/xjl271314/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/docs/dom/" class="sidebar-link">文档对象模型DOM</a></li><li><a href="/docs/bom/" class="sidebar-link">浏览器对象 BOM</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javaScript基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javaScript高级技巧</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/docs/es/" class="sidebar-link">ES6到ES11特性总结</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS相关知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Svg相关知识</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/docs/http/" class="sidebar-link">HTTP相关知识</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/docs/safe/" class="sidebar-link">Web安全问题</a></li><li><a href="/docs/git/" class="sidebar-link">git相关知识</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/react/lifestyle.html" class="sidebar-link">生命周期详解</a></li><li><a href="/docs/react/dom.html" class="sidebar-link">虚拟DOM</a></li><li><a href="/docs/react/diff.html" class="sidebar-link">Diff算法</a></li><li><a href="/docs/react/fiber.html" class="sidebar-link">Fiber算法</a></li><li><a href="/docs/react/component.html" class="sidebar-link">类组件与函数式组件</a></li><li><a href="/docs/react/com.html" class="sidebar-link">PureComponent与Component</a></li><li><a href="/docs/react/setState.html" class="sidebar-link">setState</a></li><li><a href="/docs/react/redux.html" class="active sidebar-link">Rudex 与 React-Redux</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/react/redux.html#redux的实现" class="sidebar-link">redux的实现</a></li><li class="sidebar-sub-header"><a href="/docs/react/redux.html#react-redux的实现" class="sidebar-link">react-redux的实现</a></li><li class="sidebar-sub-header"><a href="/docs/react/redux.html#redux-middleware实现" class="sidebar-link">redux Middleware实现</a></li></ul></li><li><a href="/docs/react/hooksRedux.html" class="sidebar-link">React Hooks Redux</a></li><li><a href="/docs/react/reduxSaga.html" class="sidebar-link">使用Redux Saga来管理副作用</a></li><li><a href="/docs/react/mobx.html" class="sidebar-link">使用Mobx来管理React应用</a></li><li><a href="/docs/react/hooks.html" class="sidebar-link">React Hooks</a></li><li><a href="/docs/react/aria.html" class="sidebar-link">无障碍功能</a></li><li><a href="/docs/react/codesplit.html" class="sidebar-link">代码分割</a></li><li><a href="/docs/react/ref.html" class="sidebar-link">ref</a></li><li><a href="/docs/react/hoc.html" class="sidebar-link">高阶组件(HOC)</a></li><li><a href="/docs/react/jsx.html" class="sidebar-link">深入jsx</a></li><li><a href="/docs/react/portal.html" class="sidebar-link">Portal</a></li><li><a href="/docs/react/syntheticEvent.html" class="sidebar-link">合成事件(SyntheticEvent)</a></li><li><a href="/docs/react/optimization.html" class="sidebar-link">性能优化</a></li><li><a href="/docs/react/webpack.html" class="sidebar-link">create-react-app中集成webpack</a></li><li><a href="/docs/react/recompose.html" class="sidebar-link">使用recompose优化你的React组件</a></li><li><a href="/docs/react/problems.html" class="sidebar-link">常见问题汇总</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Electron</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/docs/bff/" class="sidebar-link">BFF</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开放性问题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>即时通讯</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器插件扩展</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rudex-与-react-redux">Rudex 与 React-Redux</h1> <p>这个章节我们旨在达到3个目的:</p> <ol><li>理解<code>redux</code>的设计思路及实现原理</li> <li>理解<code>react-redux</code>的设计思路及实现原理</li> <li>理解<code>redux中间件</code>的设计思路及实现原理</li></ol> <h2 id="redux的实现">redux的实现</h2> <p>Q：<strong>为什么需要Redux? Redux帮助我们解决了什么问题？</strong></p> <p>A：<code>React</code>是一个组件化开发的UI库，组件之间存在着大量的通信，有的时候这个通信跨域多个组件，或者多个组件之间共享同一套数据，简单的父子组件之间传值不能满足我们的需求。自然而然的我们需要有一个地方存取和操作这些公共状态。而<code>Redux</code>就为我们提供了一种管理公共状态的方案。</p> <p>Q: <strong>如何管理公共状态?</strong></p> <p>A:既然是公共状态，那么我们把公共状态提取出来就好了。我们创建一个<code>store.js</code>文件，然后直接在里边存放公共的<code>state</code>，其他组件只要引入这个<code>store</code>就可以存取公共状态了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这是最简单的store设计，当然这样做存在两个比较大的缺点:</p> <p><strong>1. 容易误操作</strong></p> <p>比如有人不小心把<code>store</code>清空了，或者误修改了其他组件的数据，那显然不太安全，出错了也很难排查。因此我们需要有条件的操作<code>store</code>，防止直接修改<code>store</code>内部存取的数据。</p> <p><strong>2. 可读性比较差</strong></p> <p>js是一门极其依赖语义化的语言，试想如果在代码中不经注释直接修改了公共的<code>state</code>,在多人维护的场景下，为了搞清楚<code>state</code>的含义，还要翻看多处的代码，所以最好给每个操作都起个名字。</p> <p>Q: <strong>如何根据上述情况重新设计store？</strong></p> <p>A：根据上面的分析，我们希望公共状态既能被全局访问到，又是私有的不能被直接修改。这一点刚好可以使用<code>闭包</code>来实现。我们要存取状态，那么又涉及到<code>getter</code>和<code>setter</code>,当状态发生变化的时候，通知组件状态发生了变更。正好对应<code>redux</code>的三个API:<code>getState</code>、<code>dispatch</code>、<code>subscribe</code>。</p> <p>大致的<code>store</code>轮廓:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">store</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">,</span>
        dispatch<span class="token punctuation">,</span>
        subscribe
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Q: <strong><code>getState()函数的实现?</code></strong></p> <p>A: <code>getState()实现非常简单</code>，只需要返回<code>store</code>的当前状态值即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 公共状态</span>
    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// getter</span>
        <span class="token keyword">return</span> currentState
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">,</span>
        dispatch<span class="token punctuation">,</span>
        subscribe
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Q: <strong><code>dispatch()函数的实现?</code></strong></p> <p>A: <code>dispatch()函数</code>的实现，我们的目标是有条件、具名的修改<code>store</code>的数据。在使用<code>dispatch</code>的时候，我们会给<code>dispatch()</code>传入一个<code>action</code>对象，这个对象包括我们要修改的<code>state</code>以及这个操作的名字<code>actionType</code>，根据<code>type</code>的不同，<code>store</code>会修改对应的<code>state</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentState
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'add'</span><span class="token operator">:</span>
                currentState <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token operator">...</span>state<span class="token punctuation">,</span>
                    count<span class="token operator">:</span> currentState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">,</span>
        dispatch<span class="token punctuation">,</span>
        subscribe
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们把对<code>actionType</code>的判断写在<code>dispatch</code>中显得臃肿，也很笨拙我们把修改state的规则抽离出来到一个<code>reducer</code>中。</p> <p>Q: <strong><code>reducer()函数的实现?</code></strong></p> <p>A: <code>reducer</code>的目的是根据<code>action</code>对象的<code>type</code>来更新状态。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reducer'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentState
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        currentState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'@REDUX_INIT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化store数据</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">,</span>
        dispatch<span class="token punctuation">,</span>
        subscribe
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// reducer.js</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'add'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>state<span class="token punctuation">,</span>
                count<span class="token operator">:</span>state<span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token string">'substract'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                 <span class="token operator">...</span>state<span class="token punctuation">,</span>
                count<span class="token operator">:</span>state<span class="token punctuation">.</span>count<span class="token operator">-</span><span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> initialState
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Q: <code>subscribe()函数</code>的实现</p> <p>A: 尽管我们已经能够存取公共的<code>state</code>,但<code>state</code>的变化并不会直接引起视图的更新，我们需要监听<code>store</code>的变化，这里我们应用一个设计模式————观察者模式，观察者模式被广泛应用于监听事件实现。</p> <p><strong>观察者模式的简单实现</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>update <span class="token operator">=</span> fn
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>observers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token operator">=&gt;</span>observer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'被观察者发出通知'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span>

subject<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span>
subject<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span>
subject<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><code>subscribe()</code>函数的实现就类似上述，每次<code>dispatch</code>的时候都进行广播。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> reducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reducer'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> observers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentState
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        currentState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'@REDUX_INIT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化store数据</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">,</span>
        dispatch<span class="token punctuation">,</span>
        subscribe
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里一个简单的<code>redux</code>就已经完成了，但是我们在使用<code>store</code>的时候，需要在每个组件中引入<code>store</code>，然后<code>getState</code>，然后<code>dispatch</code>，还有<code>subscribe</code>，代码比较冗余，我们需要合并一些重复的操作，而其中一个解决方案就是<code>react-redux</code>。</p> <h2 id="react-redux的实现">react-redux的实现</h2> <p>上文实现的redux在一个组件如果要从store中存取公共状态的时候需要进行4步操作：</p> <ol><li>import 引入 store</li> <li>getState获取状态</li> <li>dispatch修改状态</li> <li>subscribe订阅更新</li></ol> <p>步骤繁琐，代码相对冗余。<code>react-redux</code>提供了<code>Provider</code>和<code>connect</code>两个API,<code>Provider</code>将<code>store</code>放入了<code>this.context</code>中，省去了<code>import</code>这个步骤，<code>connect</code>将<code>getState</code>、<code>dispatch</code>合并进了<code>this.props</code>,并自动订阅更新，简化了另外三个步骤。</p> <p>Q: <strong>Provider的实现?</strong></p> <p>A: <code>Provider</code>是一个组件，接收一个<code>store</code>并将其放入全局的<code>context</code>对象中。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">'props-types'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Provider</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
    <span class="token comment">// 需要声明静态属性childContextTypes来指定context对象的属性 固定写法</span>
    <span class="token keyword">static</span> childContextTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
        store<span class="token operator">:</span> PropTypes<span class="token punctuation">.</span>object
    <span class="token punctuation">}</span>

    <span class="token comment">// 实现getChildContext方法，返回context对象 固定写法</span>
    <span class="token function">getChildContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            store<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>store <span class="token operator">=</span> props<span class="token punctuation">.</span>store
    <span class="token punctuation">}</span>

    <span class="token comment">// 渲染被Provider包裹的组件</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>完成<code>Provider</code>之后，我们就能在组件中通过<code>this.context.store</code>这样的形式获取到<code>store</code>,不需要再单独的<code>import</code>。</p> <p>Q: <strong>connect()函数的实现?</strong></p> <p>A: <code>connect(mapStateToProps, mapDispatchToProps)(App)</code>是一个高阶函数，接收一个组件然后返回一个新的组件。<code>connect</code>根据传入的<code>map</code>将<code>state</code>和<code>dispatch</code>方法挂载到组件的<code>props</code>上。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token parameter">mapStateToProps<span class="token punctuation">,</span> mapDispatchToProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">class</span> <span class="token class-name">Connect</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
            <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 从context中获取store并订阅更新</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleStoreChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token function">handleStoreChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 触发更新</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 或者找出变化的状态然后setState进行更新</span>
            <span class="token punctuation">}</span>

            <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token operator">&lt;</span>Component
                    <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span>
                    <span class="token punctuation">{</span><span class="token operator">...</span><span class="token function">mapStateToProps</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
                    <span class="token punctuation">{</span><span class="token operator">...</span><span class="token function">mapDispatchToProps</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">}</span>
                <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 接收context的固定写法</span>
        Connect<span class="token punctuation">.</span>contextTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
            store<span class="token operator">:</span> PropsTypes<span class="token punctuation">.</span>object
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Connect
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="redux-middleware实现">redux Middleware实现</h2> <p>所谓中间件，我们理解为<code>拦截器</code>，用于对某些过程进行拦截和处理，且中间件能够串行使用。在<code>redux</code>中，我们中间件拦截的是<code>dispatch</code>提交到<code>reducer</code>这个过程，从而增加<code>dispatch</code>的功能。</p> <p>Q: 如何来实现一个每次<code>dispatch</code>之后手动打印<code>store</code>的中间件？</p> <p>A: 封装一个公用的dispatch方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> next <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch
store<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatchAndLog</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'prev state'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'next state'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>简单的替换确实可以达到上述的效果，但是假如我们需要其他的中间件，随着功能模块的增多，代码量会迅速膨胀，以后这个中间件就没法维护了，我们希望不同的功能是独立的可插拔的模块。</p> <h3 id="模块化">模块化</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 日志打印中间件</span>
<span class="token keyword">function</span> <span class="token function">patchStoreToAddLogger</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> next <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch
    store<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatchAndLog</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'prev state'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'next state'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 错误监控中间件</span>
<span class="token keyword">function</span> <span class="token function">patchStoreToAddErrorCatch</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">let</span> next <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch
     store<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatchAndShowErrors</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">try</span><span class="token punctuation">{</span>
             <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
             console<span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">'捕获一个异常'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
             <span class="token keyword">throw</span> err
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">patchStoreToAddLogger</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
<span class="token function">patchStoreToAddErrorCatch</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
</code></pre></div><p>到这里我们基本实现了可组合，可插拔的中间件，但是代码可以进行优化。我们上述都是先获取<code>dispatch</code>然后在方法内部替换<code>dispatch</code>，这部分代码可以进行优化:我们不在方法内替换<code>dispatch</code>，而是返回一个新的<code>dispatch</code>，然后让循环来进行每一步的替换。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> next <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch
    
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">dispatchAndLog</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'next state'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在<code>redux</code>中增加一个辅助方法<code>applyMiddleware</code>，用于添加中间件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> middlewares</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>middlewares<span class="token punctuation">]</span> <span class="token comment">// 浅拷贝数组避免reverse改变原数组</span>
    middlewares<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 循环替换dispatch</span>
    middlewares<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token operator">=&gt;</span>store<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样的话我们就能使用下面的方式进行增加中间件了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span> logger<span class="token punctuation">,</span> errCatch<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>这个函数功能上已经满足了我们的需求但是看起来还是不够<code>纯</code>，函数在函数体内修改了<code>store</code>自身的<code>dispatch</code>,产生了所谓的副作用，我们可以把<code>applyMiddleware</code>作为高阶函数,用于增强<code>store</code>而不是替换<code>dispatch</code>。</p> <p>先对<code>createStore</code>进行一个小改造.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> heightener</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// heightener是一个高阶函数 用于增强createStore</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>heightener<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">heightener</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> currentState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> observers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentState
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        currentState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'@@INIT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">,</span>
        dispatch<span class="token punctuation">,</span>
        subscribe
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 中间件进一步柯里化</span>
<span class="token keyword">const</span> <span class="token function-variable function">looger</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log1'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">thunk</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'thunk'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span> <span class="token operator">=</span> store
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">logger2</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log2'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// 改造applyMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">applyMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">createStore</span> <span class="token operator">=&gt;</span> <span class="token parameter">reducer</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> store
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
        getState<span class="token punctuation">,</span>
        <span class="token function-variable function">dispatch</span><span class="token operator">:</span><span class="token parameter">action</span><span class="token operator">=&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        <span class="token comment">// 这里不直接dispatch的原因是？</span>
        <span class="token comment">// 直接dispatch会产生闭包。导致所有中间件共享一个dispatch</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> middlewareArr <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token operator">=&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>

    dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewareArr<span class="token punctuation">)</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span>

    <span class="token keyword">return</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>store<span class="token punctuation">,</span>
        dispatch
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// compose对应了middlewares.reverse()</span>
<span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fns</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token parameter">arg</span><span class="token operator">=&gt;</span>arg
    <span class="token keyword">if</span><span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> fns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">res</span><span class="token punctuation">(</span><span class="token function">cur</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">2020-06-05 07:00:00</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/react/setState.html" class="prev">
        setState
      </a></span> <span class="next"><a href="/docs/react/hooksRedux.html">
        React Hooks Redux
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div class="gitalk-container"><div id="gitalk-container"></div></div><div></div><!----></div></div>
    <script src="/docs/assets/js/app.8c7fcf95.js" defer></script><script src="/docs/assets/js/2.346c741e.js" defer></script><script src="/docs/assets/js/159.dd6ae020.js" defer></script>
  </body>
</html>
