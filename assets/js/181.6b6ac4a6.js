(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{839:function(e,s,t){"use strict";t.r(s);var _=t(14),v=Object(_.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"keyspace-notification（键空间通知）"}},[e._v("Keyspace Notification（键空间通知）")]),e._v(" "),t("ul",[t("li",[e._v("2020.05.25")])]),e._v(" "),t("h2",{attrs:{id:"需求分析"}},[e._v("需求分析")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("在"),t("code",[e._v("Redis")]),e._v("中设置了生存时间的"),t("code",[e._v("Key")]),e._v("，在过期时能不能有所提示？")])]),e._v(" "),t("li",[t("p",[e._v("如果能对过期"),t("code",[e._v("Key")]),e._v("有个监听，如何对过期"),t("code",[e._v("Key")]),e._v("进行一个回调处理？")])]),e._v(" "),t("li",[t("p",[e._v("如何使用 "),t("code",[e._v("Redis")]),e._v(" 来实现定时任务？")])])]),e._v(" "),t("h2",{attrs:{id:"解决方案"}},[e._v("解决方案")]),e._v(" "),t("p",[e._v("在 "),t("code",[e._v("Redis")]),e._v(" 的 "),t("code",[e._v("2.8.0")]),e._v(" 版本之后，其推出了一个新的特性————"),t("code",[e._v("键空间消息（Redis Keyspace Notifications）")]),e._v("，它配合 "),t("code",[e._v("2.0.0")]),e._v(" 版本之后的 "),t("code",[e._v("SUBSCRIBE")]),e._v(" 就能完成这个定时任务。")]),e._v(" "),t("h2",{attrs:{id:"publish-subscribe"}},[e._v("Publish / Subscribe")]),e._v(" "),t("p",[t("code",[e._v("Redis")]),e._v(" 在 "),t("code",[e._v("2.0.0")]),e._v(" 之后推出了 "),t("code",[e._v("Pub / Sub")]),e._v(" 的指令，大致就是说一边给 "),t("code",[e._v("Redis")]),e._v(" 的特定频道发送消息，另一边从 "),t("code",[e._v("Redis")]),e._v(" 的特定频道取值————形成了一个简易的"),t("code",[e._v("消息队列")]),e._v("。")]),e._v(" "),t("h2",{attrs:{id:"redis-keyspace-notifications"}},[e._v("Redis Keyspace Notifications")]),e._v(" "),t("p",[e._v("在 "),t("code",[e._v("Redis")]),e._v(" 里面有一些事件，比如"),t("code",[e._v("键到期")]),e._v("、"),t("code",[e._v("键被删除")]),e._v("等。然后我们可以通过配置一些东西来让 "),t("code",[e._v("Redis")]),e._v(" 一旦触发这些事件的时候就往特定的 "),t("code",[e._v("Channel")]),e._v(" 推一条消息。")]),e._v(" "),t("p",[e._v("大致的流程就是我们给 "),t("code",[e._v("Redis")]),e._v(" 的某一个 "),t("code",[e._v("db")]),e._v(" 设置过期事件，使其键一旦过期就会往特定频道推消息，我在自己的客户端这边就一直消费这个频道就好了。")]),e._v(" "),t("p",[e._v("以后一来一条定时任务，我们就把这个任务状态压缩成一个键，并且过期时间为距这个任务执行的时间差。那么当键一旦到期，就到了任务该执行的时间，"),t("code",[e._v("Redis")]),e._v(" 自然会把过期消息推去，我们的客户端就能接收到了。这样一来就起到了定时任务的作用。")]),e._v(" "),t("h2",{attrs:{id:"key过期事件的redis配置"}},[e._v("Key过期事件的Redis配置")]),e._v(" "),t("blockquote",[t("p",[e._v("这里需要配置 "),t("code",[e._v("notify-keyspace-events")]),e._v(" 的参数为 "),t("code",[e._v("Ex")]),e._v("。"),t("code",[e._v("x")]),e._v(" 代表了"),t("code",[e._v("过期事件")]),e._v("。"),t("code",[e._v("notify-keyspace-events Ex")]),e._v(" 保存配置后，重启"),t("code",[e._v("Redis")]),e._v("服务，使配置生效。")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200525190205251.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70",alt:"notify-keyspace-events"}})]),e._v(" "),t("p",[e._v("配置完成后执行")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("brew services restart redis\n")])])]),t("h3",{attrs:{id:"添加过期事件订阅-开启一个终端，redis-cli-进入-redis-。开始订阅所有操作，等待接收消息。"}},[e._v("添加过期事件订阅 开启一个终端，redis-cli 进入 redis 。开始订阅所有操作，等待接收消息。")]),e._v(" "),t("div",{staticClass:"language-r extra-class"},[t("pre",{pre:!0,attrs:{class:"language-r"}},[t("code",[e._v("redis"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("cli "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("h "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v(".1")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("p "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("6379")]),e._v("\n\npsubscribe __keyevent"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("@")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("__"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("expired\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# PSUBSCRIBE 命令订阅一个或多个符合给定模式的频道，0代表数据库0")]),e._v("\n")])])]),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200525191847885.png",alt:"执行结果"}})]),e._v(" "),t("h3",{attrs:{id:"再开启一个终端，redis-cli-进入-redis，新增一个-10秒过期的键："}},[e._v("再开启一个终端，redis-cli 进入 redis，新增一个 10秒过期的键：")]),e._v(" "),t("div",{staticClass:"language-r extra-class"},[t("pre",{pre:!0,attrs:{class:"language-r"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# SETEX key seconds value")]),e._v("\nsetex test "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("123")]),e._v("\n")])])]),t("h3",{attrs:{id:"另外一边执行了阻塞订阅操作后的终端，10秒过期后有如下信息输出："}},[e._v("另外一边执行了阻塞订阅操作后的终端，10秒过期后有如下信息输出：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200525193252154.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70",alt:"输出"}})])])}),[],!1,null,null,null);s.default=v.exports}}]);